<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stavla ‚Äì Interaktiv stamtavla</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

body { background: #eae6e0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

#topbar {
  flex-shrink: 0; background: #fff; border-bottom: 1px solid #ddd;
  padding: 10px 20px; display: flex; align-items: center; gap: 16px;
  box-shadow: 0 1px 4px rgba(0,0,0,.08);
}
#topbar h1 { font-size: 16px; font-weight: 700; color: #333; }
#focus-name { font-size: 14px; color: #666; flex: 1; }
#back { padding: 6px 14px; border-radius: 20px; border: 1.5px solid #ccc; background: white; font-size: 13px; cursor: pointer; color: #555; transition: background .1s; }
#back:hover:not(:disabled) { background: #f0f0f0; }
#back:disabled { opacity: .35; cursor: default; }
.hint { font-size: 11px; color: #bbb; white-space: nowrap; }

#viewport { flex: 1; overflow: auto; position: relative; touch-action: pan-x pan-y; }

#wrap { position: relative; }

canvas#cv { position: absolute; top: 0; left: 0; pointer-events: none; }

/* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
.card {
  position: absolute; display: flex; align-items: flex-start; gap: 5px;
  padding: 5px 8px 5px 6px; border-radius: 14px; border: 2px solid;
  width: 168px; transform: translateY(-50%);
  background: white; cursor: pointer;
  transition: filter .12s, box-shadow .12s;
}
.card:hover { filter: brightness(.96); box-shadow: 0 3px 12px rgba(0,0,0,.14); z-index: 5; }
.card.focused { box-shadow: 0 0 0 3px rgba(100,80,200,.35); z-index: 6; cursor: default; }

.av { width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 12px; color: white; margin-top: 1px; }

.info { flex: 1; min-width: 0; }
.nm { font-size: 11px; font-weight: 700; color: #222; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dt { font-size: 9.5px; color: #888; margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.note { font-size: 9px; color: #aaa; font-style: italic; }

.sibs { margin-top: 5px; padding-top: 4px; border-top: 1px solid rgba(0,0,0,.07); display: flex; flex-wrap: wrap; gap: 3px; }
.sib { font-size: 10px; padding: 2px 7px; border-radius: 10px; border: 1px solid; cursor: pointer; white-space: nowrap; transition: filter .1s; background: white; }
.sib:hover { filter: brightness(.92); }

/* Colour themes */
.c-sv   { border-color: #5ab6e0; background: #eaf5fc; } .c-sv   .av { background: #5ab6e0; }
.c-svb  { border-color: #52bb52; background: #eafaea; } .c-svb  .av { background: #52bb52; }
.c-rs   { border-color: #e06060; background: #fbeaea; } .c-rs   .av { background: #e06060; }
.c-de   { border-color: #d0b040; background: #fdf8e0; } .c-de   .av { background: #d0b040; }
.c-mix  { border-color: #9060d0; background: #f4eefb; } .c-mix  .av { background: #9060d0; }
.c-unk  { border-color: #bbb;    background: #f7f7f7; } .c-unk  .av { background: #bbb;    }
.c-unk .nm { color: #999; font-style: italic; }

/* Sibling chip colours */
.sib-sv  { border-color: #5ab6e0; color: #2a7090; }
.sib-svb { border-color: #52bb52; color: #2a6030; }
.sib-rs  { border-color: #e06060; color: #903030; }
.sib-de  { border-color: #d0b040; color: #705010; }
.sib-mix { border-color: #9060d0; color: #503090; }
.sib-unk { border-color: #bbb;    color: #888;    }
.barn { margin-top: 4px; padding-top: 4px; border-top: 1px dashed rgba(0,0,0,.1);
        display: flex; flex-wrap: wrap; gap: 3px; }
.barn::before { font-size: 10px; font-weight: 700; color: #ccc; }
body.lang-sv .barn::before { content: 'barn: '; }
body.lang-de .barn::before { content: 'Kinder: '; }

/* Language toggle */
#lang-toggle { display: flex; gap: 3px; margin-left: 8px; }
.lang-btn { font-size: 17px; background: none; border: 2px solid transparent;
            border-radius: 6px; padding: 1px 4px; cursor: pointer;
            opacity: .4; line-height: 1; transition: opacity .1s; }
.lang-btn:hover { opacity: .75; }
.lang-btn.active { border-color: #bbb; opacity: 1; }
.child { font-size: 10px; padding: 2px 7px; border-radius: 10px; cursor: pointer;
         white-space: nowrap; transition: filter .1s; border: none; }
.child:hover { filter: brightness(.88); }
.child-sv   { background: #cce8f5; color: #1a608a; }
.child-svb  { background: #c8eec8; color: #1a5a1a; }
.child-rs   { background: #f5cccc; color: #8a1a1a; }
.child-de   { background: #f5e8a0; color: #6a4a00; }
.child-mix  { background: #dcc8f5; color: #4a1a9a; }
.child-unk  { background: #e0e0e0; color: #555; }


/* Gen labels */
.gen-lbl { position: absolute; top: 10px; font-size: 10px; font-weight: 700; letter-spacing: .5px; color: #bbb; text-transform: uppercase; white-space: nowrap; pointer-events: none; }

/* ‚îÄ‚îÄ Main layout ‚îÄ‚îÄ */
#main { flex: 1; display: flex; overflow: hidden; }
#zoom-layer { position: relative; }

/* ‚îÄ‚îÄ Zoom controls ‚îÄ‚îÄ */
#zoom-controls {
  position: fixed; bottom: 22px; left: 18px; z-index: 20;
  display: flex; flex-direction: column; gap: 5px;
}
.zoom-btn {
  width: 38px; height: 38px; border-radius: 50%;
  border: 1.5px solid #ccc; background: white;
  font-size: 22px; font-weight: 300; line-height: 1; padding: 0;
  cursor: pointer; color: #555;
  box-shadow: 0 2px 8px rgba(0,0,0,.13);
  display: flex; align-items: center; justify-content: center;
  transition: background .1s;
}
.zoom-btn:hover { background: #f0f0f0; }

/* ‚îÄ‚îÄ Detail panel ‚îÄ‚îÄ */
#detail {
  width: 272px; flex-shrink: 0;
  background: #fafafa; border-left: 1px solid #ddd;
  display: flex; flex-direction: column; overflow: hidden;
  transition: width .2s ease;
}
#detail.collapsed { width: 0; }
#det-close {
  margin-left: auto; flex-shrink: 0;
  background: none; border: none; font-size: 17px;
  color: #bbb; cursor: pointer; padding: 0 2px; line-height: 1;
}
#det-close:hover { color: #666; }
.det-head {
  padding: 14px 16px; display: flex; align-items: center; gap: 12px;
  border-bottom: 1px solid #eee; flex-shrink: 0;
}
.det-av {
  width: 44px; height: 44px; border-radius: 50%; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; color: white;
}
.det-name { font-size: 13.5px; font-weight: 700; color: #222; line-height: 1.3; }
.det-dates { font-size: 11.5px; color: #777; margin-top: 2px; }
.det-body { flex: 1; overflow-y: auto; padding: 12px 14px; }
.det-section { margin-bottom: 14px; }
.det-section h4 {
  font-size: 9.5px; font-weight: 700; letter-spacing: .6px;
  text-transform: uppercase; color: #bbb; margin-bottom: 6px;
}
.det-links { display: flex; flex-wrap: wrap; gap: 4px; }
.det-link {
  font-size: 11.5px; padding: 3px 9px; border-radius: 10px;
  border: 1px solid #ddd; background: white; cursor: pointer; color: #333;
  transition: background .1s;
}
.det-link:hover { background: #efefef; }
.det-text { font-size: 12px; color: #444; line-height: 1.6; }
.det-note { font-size: 11px; color: #999; font-style: italic; margin-top: 5px; }
.det-empty { font-size: 12px; color: #ccc; font-style: italic; padding: 20px 0; text-align: center; }

/* ‚îÄ‚îÄ Auth-zon i topbaren ‚îÄ‚îÄ */
#auth-zone { display:flex; align-items:center; gap:8px; }
#auth-open-btn {
  padding: 5px 13px; border-radius: 20px;
  border: 1.5px solid #5ab6e0; background: white;
  font-size: 12px; cursor: pointer; color: #3a80a0;
  transition: background .1s; white-space: nowrap;
}
#auth-open-btn:hover { background: #eaf5fc; }
#user-chip {
  display: none; align-items: center; gap: 7px;
  padding: 3px 10px 3px 4px; border-radius: 20px;
  border: 1.5px solid #ddd; background: white; font-size: 12px; color: #444;
}
#user-pic { width: 22px; height: 22px; border-radius: 50%; }
#sign-out-btn { background:none; border:none; font-size:11px; color:#ccc; cursor:pointer; padding:0 0 0 4px; }
#sign-out-btn:hover { color: #e06060; }

/* ‚îÄ‚îÄ Fotoikon p√• kort ‚îÄ‚îÄ */
.photo-dot {
  position: absolute; top: 3px; right: 5px;
  font-size: 11px; line-height: 1;
  text-decoration: none; opacity: .65;
}
.photo-dot:hover { opacity: 1; }

/* ‚îÄ‚îÄ Ans√∂kningsmodal ‚îÄ‚îÄ */
#apply-modal {
  position: fixed; inset: 0; background: rgba(0,0,0,.5);
  z-index: 100; display: none; align-items: center; justify-content: center;
}
#apply-box {
  background: white; border-radius: 18px; padding: 28px 28px 22px;
  max-width: 420px; width: 92%; box-shadow: 0 8px 40px rgba(0,0,0,.22);
}
#apply-box h2 { font-size: 16px; margin-bottom: 8px; color: #222; }
#apply-box p  { font-size: 12.5px; color: #666; margin-bottom: 18px; line-height: 1.55; }
.apply-field { margin-bottom: 13px; }
.apply-field label { display:block; font-size:10px; font-weight:700; color:#aaa; margin-bottom:4px; text-transform:uppercase; letter-spacing:.5px; }
.apply-field input, .apply-field textarea {
  width: 100%; border: 1.5px solid #ddd; border-radius: 10px;
  padding: 8px 11px; font-size: 13px; font-family: inherit; outline: none;
  transition: border-color .15s; box-sizing: border-box;
}
.apply-field input:focus, .apply-field textarea:focus { border-color: #5ab6e0; }
.apply-field textarea { resize: vertical; min-height: 72px; }
#apply-submit {
  width: 100%; padding: 10px; border-radius: 12px; border: none;
  background: #5ab6e0; color: white; font-size: 14px; font-weight: 700;
  cursor: pointer; transition: background .1s; margin-top: 4px;
}
#apply-submit:hover { background: #3a96c0; }
#apply-submit:disabled { background: #bbb; cursor: default; }
#apply-cancel, #apply-cancel2, #apply-cancel3 {
  font-size: 12px; color: #bbb; background:none; border:none; cursor:pointer;
  margin-top: 10px; display: block; width: 100%; text-align: center;
}
#apply-cancel:hover, #apply-cancel2:hover, #apply-cancel3:hover { color: #888; }
#apply-status { font-size: 12.5px; margin-top: 8px; text-align: center; min-height: 18px; }
#gsi-btn-container { display: flex; justify-content: center; margin-top: 12px; }
.apply-success-icon { font-size: 36px; text-align:center; margin: 10px 0; }

/* ‚îÄ‚îÄ Fotol√§nk i detaljpanelen ‚îÄ‚îÄ */
.photos-link {
  display: inline-block; margin-top: 6px;
  padding: 6px 12px; border-radius: 8px;
  background: #2a2a2a; color: #ccc;
  font-size: 13px; text-decoration: none;
  transition: background .15s, color .15s;
}
.photos-link:hover { background: #3a3a3a; color: #fff; }
</style>
</head>
<body class="lang-sv">

<div id="topbar">
  <h1>Stamtavla</h1>
  <span id="focus-name"></span>
  <button id="back" disabled>‚Üê Tillbaka</button>
  <span class="hint">Klicka ett syskon f√∂r att centrera tr√§det p√• den personen</span>
  <div id="lang-toggle">
    <button class="lang-btn active" data-lang="sv">üá∏üá™</button>
    <button class="lang-btn"        data-lang="de">üá©üá™</button>
  </div>
  <div id="auth-zone">
    <button id="auth-open-btn" onclick="openApplyModal()">üì∑ Bildarkiv</button>
    <div id="user-chip">
      <img id="user-pic" src="" alt="">
      <span id="user-name"></span>
      <button id="sign-out-btn" onclick="signOut()" title="Logga ut">‚úï</button>
    </div>
  </div>
</div>

<div id="main">
  <div id="viewport">
    <div id="zoom-layer">
      <div id="wrap">
        <canvas id="cv"></canvas>
      </div>
    </div>
  </div>
  <div id="detail">
    <div class="det-empty">V√§lj en person i tr√§det</div>
  </div>
</div>

<!-- ‚îÄ‚îÄ Ans√∂kningsmodal ‚îÄ‚îÄ -->
<div id="apply-modal">
  <div id="apply-box">

    <!-- Vy 1: Ans√∂kningsformul√§r -->
    <div id="apply-view-request">
      <h2>üì∑ Bildarkivet</h2>
      <p>Stamtavlan √§r √∂ppen f√∂r alla ‚Äî men familjebilderna √§r reserverade f√∂r sl√§ktmedlemmar.
         Fyll i formul√§ret nedan s√• h√∂r Lasse av sig inom n√•gra dagar.</p>
      <div class="apply-field">
        <label>Ditt namn</label>
        <input id="apply-name" type="text" placeholder="F√∂rnamn Efternamn" autocomplete="name">
      </div>
      <div class="apply-field">
        <label>Din Gmail-adress (anv√§nds f√∂r inloggning)</label>
        <input id="apply-email" type="email" placeholder="du@gmail.com" autocomplete="email">
      </div>
      <div class="apply-field">
        <label>Hur ing√•r du i sl√§kten?</label>
        <textarea id="apply-relation" placeholder="T.ex. jag √§r dotter till Lillemor Nilsson, allts√• ditt syskonbarn‚Ä¶"></textarea>
      </div>
      <button id="apply-submit" onclick="submitApplication()">Skicka ans√∂kan</button>
      <div id="apply-status"></div>
      <button id="apply-cancel" onclick="closeApplyModal()">Avbryt</button>
    </div>

    <!-- Vy 2: Logga in med Google (f√∂r godk√§nda) -->
    <div id="apply-view-signin" style="display:none">
      <h2>üì∑ Bildarkivet</h2>
      <p>Du √§r godk√§nd! Logga in med ditt Google-konto f√∂r att se familjebilderna.</p>
      <div id="gsi-btn-container"></div>
      <button id="apply-cancel2" onclick="closeApplyModal()">Avbryt</button>
    </div>

    <!-- Vy 3: Ans√∂kan skickad -->
    <div id="apply-view-pending" style="display:none">
      <div class="apply-success-icon">üéâ</div>
      <h2 style="text-align:center">Ans√∂kan skickad!</h2>
      <p style="text-align:center">Lasse f√•r ett mail med din ans√∂kan och godk√§nner via sin mobil.
         Du f√•r ett v√§lkomstmail till din Gmail-adress n√§r du √§r godk√§nd.<br><br>
         <small id="apply-pending-note" style="color:#bbb"></small></p>
      <button id="apply-cancel3" onclick="closeApplyModal()">St√§ng</button>
    </div>

  </div>
</div>



<div id="zoom-controls">
  <button class="zoom-btn" id="zoom-in">+</button>
  <button class="zoom-btn" id="zoom-out">‚àí</button>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê TRANSLATIONS ‚ïê‚ïê‚ïê‚ïê
const LANG = {
  sv: {
    title:    'Stamtavla',
    back:     '‚Üê Tillbaka',
    hint:     'Klicka ett syskon f√∂r att centrera tr√§det p√• den personen',
    genLabels:['Du / Fokus','F√∂r√§ldrar','Mor-/farf√∂r√§ldrar','Gammelf√∂r√§ldrar','Ggammelf√∂r√§ldrar','Gggammelf√∂r√§ldrar'],
    detParents:  'F√∂r√§ldrar',
    detSpouse:   'Make / Maka',
    detChildren: 'Barn',
    detSiblings: 'Syskon',
    detNote:     'Anteckning',
    detEmpty:    'V√§lj en person i tr√§det',
    bildarkiv:      'Bildarkiv',
    modalTitle:     'üì∑ Bildarkivet',
    modalIntro:     'Stamtavlan √§r √∂ppen f√∂r alla ‚Äî men familjebilderna √§r reserverade f√∂r sl√§ktmedlemmar. Fyll i formul√§ret nedan s√• h√∂r Lasse av sig inom n√•gra dagar.',
    labelName:      'Ditt namn',
    phName:         'F√∂rnamn Efternamn',
    labelEmail:     'Din Gmail-adress (anv√§nds f√∂r inloggning)',
    labelRelation:  'Hur ing√•r du i sl√§kten?',
    phRelation:     'T.ex. jag √§r dotter till Lillemor Nilsson, allts√• ditt syskonbarn‚Ä¶',
    btnApply:       'Skicka ans√∂kan',
    btnCancel:      'Avbryt',
    btnClose:       'St√§ng',
    signinTitle:    'üì∑ Bildarkivet',
    signinText:     'Du √§r godk√§nd! Logga in med ditt Google-konto f√∂r att se familjebilderna.',
    pendingTitle:   'Ans√∂kan skickad!',
    pendingText:    'Lasse f√•r ett mail med din ans√∂kan och godk√§nner via sin mobil. Du f√•r ett v√§lkomstmail till din Gmail-adress n√§r du √§r godk√§nd.',
  },
  de: {
    title:    'Stammbaum',
    back:     '‚Üê Zur√ºck',
    hint:     'Klicke auf ein Geschwister, um den Baum auf diese Person zu zentrieren',
    genLabels:['Du / Fokus','Eltern','Gro√üeltern','Urgro√üeltern','Ururgro√üeltern','Urururgro√üeltern'],
    detParents:  'Eltern',
    detSpouse:   'Ehepartner',
    detChildren: 'Kinder',
    detSiblings: 'Geschwister',
    detNote:     'Notiz',
    detEmpty:    'W√§hle eine Person im Baum aus',
    bildarkiv:      'Fotoarchiv',
    modalTitle:     'üì∑ Fotoarchiv',
    modalIntro:     'Der Stammbaum ist f√ºr alle zug√§nglich ‚Äî aber die Familienfotos sind Familienmitgliedern vorbehalten. F√ºllen Sie das Formular aus, und Lasse meldet sich innerhalb weniger Tage.',
    labelName:      'Ihr Name',
    phName:         'Vorname Nachname',
    labelEmail:     'Ihre Gmail-Adresse (f√ºr die Anmeldung)',
    labelRelation:  'Wie geh√∂ren Sie zur Familie?',
    phRelation:     'Z.B. ich bin die Tochter von Lillemor Nilsson, also Ihre Nichte‚Ä¶',
    btnApply:       'Anfrage senden',
    btnCancel:      'Abbrechen',
    btnClose:       'Schlie√üen',
    signinTitle:    'üì∑ Fotoarchiv',
    signinText:     'Sie sind genehmigt! Melden Sie sich mit Ihrem Google-Konto an, um die Familienfotos zu sehen.',
    pendingTitle:   'Anfrage gesendet!',
    pendingText:    'Lasse erh√§lt eine E-Mail mit Ihrer Anfrage und genehmigt sie √ºber sein Mobiltelefon. Sie erhalten eine Willkommens-E-Mail, sobald Sie genehmigt sind.',
  }
};
let lang = 'sv';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PEOPLE DATA
// fi = fatherId, mi = motherId
// b = born, d = died, s = sex (M/F), c = color class
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const P = {
  lasse:     {n:"Lasse Nilsson",           b:"1975",          s:"M",c:"mix",fi:"leif",      mi:"marijana",
             desc:"Lasse Nilsson, f√∂dd i √Ñlvsborg, G√∂teborg. Har r√∂tter i tre l√§nder: Sverige (Nilsson/Bergman fr√•n Mj√∂lby och Lysekil), Serbien (Mitrovic/Blagojevic fr√•n Soko Banja) och Tyskland (Lammerding/Schr√§der fr√•n Borghorst).",
             desc_de:"Lasse Nilsson, geboren in √Ñlvsborg, G√∂teborg. Hat Wurzeln in drei L√§ndern: Schweden (Nilsson/Bergman aus Mj√∂lby und Lysekil), Serbien (Mitrovic/Blagojevic aus Soko Banja) und Deutschland (Lammerding/Schr√§der aus Borghorst)."},
  sanna:     {n:"Sanna Nilsson",           b:"1977",          s:"F",c:"mix",fi:"leif",      mi:"marijana"},
  matti:     {n:"Matti Nilsson",           b:"1983",          s:"M",c:"mix",fi:"leif",      mi:"marijana"},
  leif:      {n:"Leif Nilsson",            b:"1942",          s:"M",c:"sv", fi:"tage",      mi:"lilian"},
  marijana:  {n:"Marijana Mitrovic",       b:"1946",          s:"F",c:"rs", fi:"ceda",      mi:"kathe"},
  lillemor:  {n:"Lillemor Nilsson",        b:"1944",          s:"F",c:"sv", fi:"tage",      mi:"lilian"},
  perolof:   {n:"Per-Olof Nilsson",        b:"1946",d:"1992", s:"M",c:"sv", fi:"tage",      mi:"lilian"},
  elisabeth: {n:"Elisabeth Nilsson",       b:"1949",d:"2026", s:"F",c:"sv", fi:"tage",      mi:"lilian"},
  tage:      {n:"Carl Tage Nilsson",       b:"1919",d:"1990", s:"M",c:"sv", fi:"kalle",     mi:"alma"},
  lilian:    {n:"Lilian Bergman",          b:"1920",d:"2000", s:"F",c:"svb",fi:"olof",      mi:"elsa"},
  ceda:      {n:"Cedomir Mitrovic",        b:"1912",d:"1981", s:"M",c:"rs", fi:"petar",     mi:"stanija",
             desc:"Cedomir \"Ceda\" Mitrovic, uppvuxen i Soko Banja. Gick i milit√§rskola och tj√§nstgjorde i Pirot (1937‚Äì40) och Ni≈°. Angiven och arresterad i Ni≈° juli 1942. F√§ngslad i Belgrad aug‚Äìokt 1942. Deporterades till KZ Mauthausen (okt 1942), sedan Auschwitz/Birkenau/Dora (april 1943‚Äìjan 1945), Nordhausen (jan‚Äìmars 1945) och Bergen-Belsen (mars‚Äìapril 1945). Befriad av engelsm√§nnen 15 april 1945. Tr√§ffade K√§the i DP-l√§gret Borghorst. Bosatte sig i M√ºnster 1950, k√∂pte hus i Zajeƒçar till sin mor ~1962. F√∂delse√•r 1912 bekr√§ftat via Arolsen Archives (4 prim√§rk√§llor).",
             desc_de:"Cedomir \"Ceda\" Mitrovic, aufgewachsen in Soko Banja. Besuchte eine Milit√§rschule und diente in Pirot (1937‚Äì40) und Ni≈°. Im Juli 1942 in Ni≈° denunziert und verhaftet. Aug.‚ÄìOkt. 1942 in Belgrad inhaftiert. Deportiert ins KZ Mauthausen (Okt. 1942), dann Auschwitz/Birkenau/Dora (April 1943‚ÄìJan. 1945), Nordhausen (Jan.‚ÄìM√§rz 1945) und Bergen-Belsen (M√§rz‚ÄìApril 1945). Am 15. April 1945 von den Briten befreit. Lernte K√§the im DP-Lager Borghorst kennen. Lie√ü sich 1950 in M√ºnster nieder, kaufte ~1962 ein Haus in Zajeƒçar f√ºr seine Mutter. Geburtsjahr 1912 durch Arolsen Archives best√§tigt (4 Prim√§rquellen)."},
  kathe:     {n:"K√§the Lammerding",        b:"1926",d:"2009", s:"F",c:"de", fi:"willibald", mi:"trudis",
             desc:"Katharina Mathilde Josefine Lammerding, kallad K√§the. F√∂dd i Borghorst, dotter till Willibald och Gertrud (Trudis). Tr√§ffade Ceda Mitrovic i DP-l√§gret Borghorst efter kriget. Gifte sig och fick tre d√∂ttrar: Marijana, Vera och Jela.",
             desc_de:"Katharina Mathilde Josefine Lammerding, genannt K√§the. Geboren in Borghorst, Tochter von Willibald und Gertrud (Trudis). Lernte Ceda Mitrovic im DP-Lager Borghorst nach dem Krieg kennen. Heiratete ihn und bekam drei T√∂chter: Marijana, Vera und Jela."},
  annemarie: {n:"Anne-Marie Nilsson",      b:"1917",          s:"F",c:"sv", fi:"kalle",     mi:"alma"},
  yngve:     {n:"Carl Yngve Nilsson",      b:"1924",d:"1973", s:"M",c:"sv", fi:"kalle",     mi:"alma"},
  hulda:     {n:"Hulda Maria Carlsson",    b:"1908",          s:"F",c:"svb",fi:"olof",      mi:"elsa"},
  torelof:   {n:"Tor Elof Carlsson",       b:"1910",          s:"M",c:"svb",fi:"olof",      mi:"elsa"},
  gurlier:   {n:"Gurli Erika Carlsson",    b:"1910",          s:"F",c:"svb",fi:"olof",      mi:"elsa"},
  karin:     {n:"Karin Solgund Carlsson",  b:"1923",          s:"F",c:"svb",fi:"olof",      mi:"elsa"},
  mile:      {n:"Milorad Blagojevic",      b:"~1900",         s:"M",c:"rs", fi:null,        mi:"stanija"},
  dimitri:   {n:"Dimitri (f√∂rsvunnen)",    b:null,            s:"M",c:"rs", fi:null,        mi:"stanija"},
  egid:      {n:"Egid √Ñ. Lammerding",      b:"1925",d:"1944", s:"M",c:"de", fi:"willibald", mi:"trudis",
             desc:"Egid √Ñgidius Lammerding, Gefreiter i tyska arm√©n. F√∂rsvann 13 mars 1944 vid fronten i Ukraina (Bjerdytschew/Dwinitza/Raum Winnitza) under retr√§tt, bara 18 √•r gammal. Enligt Lasses gammelmormor tr√§ffades han av ett skott i huvudet (Kopfschu√ü) ‚Äî han dog troligen p√• plats men det bekr√§ftades aldrig officiellt, d√§rav status \\\"vermisst\\\" (saknad). Associerad krigskyrkog√•rd: Kyjiw.",
             desc_de:"Egid √Ñgidius Lammerding, Gefreiter. Am 13. M√§rz 1944 beim R√ºckzug an der Front in der Ukraine (Bjerdytschew/Dwinitza/Raum Winnitza) vermisst gemeldet, nur 18 Jahre alt. Laut m√ºndlicher √úberlieferung (Lasses Urgro√ümutter) traf ihn ein Kopfschuss ‚Äî er starb wahrscheinlich vor Ort, wurde aber nie offiziell best√§tigt, daher Status \\\"vermisst\\\". Zugeh√∂riger Kriegsfriedhof: Kyjiw.",
             x:"Kopfschu√ü, retr√§tt ‚Äì vermisst, ej bekr√§ftat"},
  franzl:    {n:"Franz Lammerding",        b:"1930",d:"2024", s:"M",c:"de", fi:"willibald", mi:"trudis"},
  gertrudl:  {n:"Gertrud Lammerding",      b:"1935",d:"2019", s:"F",c:"de", fi:"willibald", mi:"trudis"},
  vera:      {n:"Vera Mitrovic",           b:"1950",          s:"F",c:"rs", fi:"ceda",      mi:"kathe"},
  jela:      {n:"Jela Mitrovic",           b:"1953",          s:"F",c:"rs", fi:"ceda",      mi:"kathe"},
  marial:    {n:"Maria Lammerding",        b:"1939",d:"2018", s:"F",c:"de", fi:"willibald", mi:"trudis"},
  kalle:     {n:"Carl August Nilsson",     b:"1884",d:"1973", s:"M",c:"sv", fi:null,        mi:null,  x:'"Kalle Bank"',
             desc:"Carl August Nilsson, k√§nd som \"Kalle Bank\". M√∂belfabrikstapetserare i Mj√∂lby, √§gde m√∂belaff√§r p√• S:t Persgatan 5 med tre anst√§llda. Aff√§ren brann ned (√§ven grannaff√§ren), orsaken √§r ok√§nd. Efterl√§mnade tre barn: Anne-Marie, Tage och Yngve.",
             desc_de:"Carl August Nilsson, bekannt als \"Kalle Bank\". M√∂beltapezierer in Mj√∂lby, besa√ü ein M√∂belgesch√§ft in der S:t Persgatan 5 mit drei Angestellten. Das Gesch√§ft brannte ab (auch das Nachbargesch√§ft), Ursache unbekannt. Hinterlie√ü drei Kinder: Anne-Marie, Tage und Yngve."},
  augustl:   {n:"Carl August Linder",      b:"1863",          s:"M",c:"sv", fi:null,        mi:null,
             desc:"Carl August Linder, kvarnarbetare i Mj√∂lby. Bekr√§ftad i Riksarkivet folkr√§kning 1890 (Westra Eldsl√∂sa Rusth√•ll, Mj√∂lby). Far till Alma Maria och Carl Thure Linder. Gift med Hilda Carolina Gustafson.",
             desc_de:"Carl August Linder, M√ºhlenarbeiter in Mj√∂lby. Best√§tigt im Riksarkivet Volksz√§hlung 1890. Vater von Alma Maria und Carl Thure Linder. Verheiratet mit Hilda Carolina Gustafson."},
  hildac:    {n:"Hilda Carolina Gustafson", b:"1865",         s:"F",c:"sv", fi:"gustafh",   mi:"annabn",
             desc:"Hilda Carolina Gustafson, f√∂dd i Mj√∂lby. Bekr√§ftad i Riksarkivet folkr√§kning 1890. Gift med Carl August Linder. ‚ö†Ô∏è Trolig dotter till Gustaf Hindrik Gustafsson (*1816) och Anna Brita Nilsdotter ‚Äî men Gustaf Hindrik dog 22.4.1863, dvs. tv√• √•r innan Hildas uppgivna f√∂delse√•r 1865. M√∂jlig f√∂rklaring: Anna Britas dotter med ok√§nd far, som tog Gustafson-namnet, eller felaktigt f√∂delse√•r i 1890 √•rs census.",
             desc_de:"Hilda Carolina Gustafson, geboren in Mj√∂lby. Best√§tigt in der Volksz√§hlung 1890. Verheiratet mit Carl August Linder. ‚ö†Ô∏è Wahrscheinlich Tochter von Gustaf Hindrik Gustafsson (*1816) und Anna Brita Nilsdotter ‚Äî aber Gustaf Hindrik starb 1863, zwei Jahre vor Hildas Geburt 1865."},
  oskarfg:   {n:"Oskar Fredrik Gustafsson", b:"1856",          s:"M",c:"sv", fi:"gustafh",   mi:"annabn",
             desc:"Oskar Fredrik Gustafsson Lindgren, f√∂dd 23.6.1856 i Mj√∂lby. Bror till Hilda Carolina Gustafson (*1865). Gift med Johanna Carolina Andersdotter (*14.3.1849 Vreta kloster). Baptister ‚Äî barnen od√∂pta. Flyttade till Kristinehamn 2.7.1893. K√§lla: Linder-p√§rmens Nr 2 ‚úÖ bildbevisat (02-nr02-03-oskar-johanna.heic).",
             desc_de:"Oskar Fredrik Gustafsson Lindgren, geb. 23.6.1856 in Mj√∂lby. Bruder von Hilda Carolina Gustafson (*1865). Verheiratet mit Johanna Carolina Andersdotter (*1849). Baptisten. Zog 1893 nach Kristinehamn. Quelle: Nr. 2 im Linder-Ordner ‚úÖ."},
  gustafh:   {n:"Gustaf Hindrik Gustafsson", b:"14.8.1816",   s:"M",c:"sv", fi:null,        mi:"mariaad",
             desc:"Gustaf Hindrik Gustafsson, f√∂dd 14.8.1816 i Casab√∂g/√ñdesh√∂g. O√§kta son till pigan Maria (Margareta) Adamsdotter ‚Äî faderns namn ok√§nt. Kvarnbyggn√§stare/mj√∂lnare. Gift 11.7.1839 med Anna Brita Nilsdotter i Mj√∂lby. Dog 22.4.1863 i Mj√∂lby av lungsot (tbc). Barn: Frans Gustaf *1841, Johan Adolf *1843, Clara *1846, Anna Mathilda *1848, Johanna *1852, Oskar Fredrik *1856, Otto *1859. K√§lla: Linder-p√§rmens Nr 4 ‚úÖ bildbevisat (03-nr04-05-06.heic).",
             desc_de:"Gustaf Hindrik Gustafsson, geb. 14.8.1816 in Casab√∂g/√ñdesh√∂g. Unehelicher Sohn von Maria Adamsdotter ‚Äî Vater unbekannt. M√ºhlenmeister. Heirat 11.7.1839 mit Anna Brita Nilsdotter. Gest. 22.4.1863 an Tuberkulose. Quelle: Nr. 4 im Linder-Ordner ‚úÖ."},
  mariaad:   {n:"Maria Adamsdotter",        b:"12.8.1793",    s:"F",c:"sv", fi:null,        mi:null,
             desc:"Maria (Margareta) Adamsdotter, f√∂dd 12.8.1793 i √ñdesh√∂g. Dotter till mj√∂lnaren Adam Svensson (Nr 16) och Cajsa Johansdotter (Nr 17) p√• √ñrrm√§s. Piga ‚Äî fick o√§kta sonen Gustaf Hindrik Gustafsson *1816. Anges som 'klen' i 1843 √•rs l√§ngd, skickades till fattighuset. D√∂dsnotis ej p√•tr√§ffad. K√§lla: Linder-p√§rmens Nr 8/9 (04-nr07-10.heic).",
             desc_de:"Maria (Margareta) Adamsdotter, geb. 12.8.1793 in √ñdesh√∂g. Tochter von Adam Svensson und Cajsa Johansdotter. Magd ‚Äî unehelicher Sohn Gustaf Hindrik *1816. Quelle: Nr. 8 im Linder-Ordner."},
  annabn:    {n:"Anna Brita Nilsdotter",    b:"21.9.1814",    s:"F",c:"sv", fi:"nilsmans",  mi:"britahel",
             desc:"Anna Brita Nilsdotter, f√∂dd 21.9.1814 i √Ösbo. Dotter till torparen Nils M√•nsson (*1774 √Ösbo) och Brita Helena Larsdotter (*1779). Gift 11.7.1839 med Gustaf Hindrik Gustafsson. Dog 1.5.1876 i Mj√∂lby. Kallas 'Lindgren' i 1869‚Äì1874 √•rs l√§ngder. K√§lla: Linder-p√§rmens Nr 5 ‚úÖ bildbevisat (03-nr04-05-06.heic).",
             desc_de:"Anna Brita Nilsdotter, geb. 21.9.1814 in √Ösbo. Tochter von Nils M√•nsson (*1774) und Brita Helena Larsdotter (*1779). Heirat 1839 mit Gustaf Hindrik Gustafsson. Gest. 1.5.1876. Quelle: Nr. 5 im Linder-Ordner ‚úÖ."},
  nilsmans:  {n:"Nils M√•nsson",             b:"17.8.1774",    s:"M",c:"sv", fi:null,        mi:null,
             desc:"Nils M√•nsson, f√∂dd 17.8.1774 i √Ösbo. Torpare p√• Kruttorpet. F√∂r√§ldrar: M√•ns Svensson (Nr 20) och Maria Olofsdotter (Nr 21). Gift 14.5.1802 i √Ösbo med Brita Lena Larsdotter fr√•n Norra Kvisselhutt. Barn: Lena Kajsa *1803, Maja Lisa *1806, Sven *1810, Anna Brita *1814. K√§lla: Linder-p√§rmens Nr 10 ‚úÖ bildbevisat (04-nr07-10.heic).",
             desc_de:"Nils M√•nsson, geb. 17.8.1774 in √Ösbo. Torpare. Heirat 1802 mit Brita Lena Larsdotter. Vater von Anna Brita Nilsdotter (*1814). Quelle: Nr. 10 im Linder-Ordner ‚úÖ."},
  britahel:  {n:"Brita Helena Larsdotter",  b:"6.11.1779",    s:"F",c:"sv", fi:"larsmag",   mi:"catharinasv",
             desc:"Brita Helena Larsdotter, f√∂dd 6.11.1779 i √Ösbo. D√∂pt 'Brita Helena' men kallad 'Brita Lena'. Dotter till hemmansbrukaren Lars M√•nsson (Nr 22) och Catharina Svensdotter (Nr 23), Norra Krisshult. Gift 14.6.1802 med Nils M√•nsson. Dog 27.10.1841 i Mj√∂lby. K√§lla: Linder-p√§rmens Nr 11 ‚úÖ bildbevisat (05-nr11-13.heic). ‚ö†Ô∏è Tidigare felaktigt angiven som 'Evita Helena Larsdotter *1775' ‚Äî r√§ttat 2026-03-01.",
             desc_de:"Brita Helena Larsdotter, geb. 6.11.1779 in √Ösbo. Genannt 'Brita Lena'. Tochter von Lars M√•nsson und Catharina Svensdotter. Gest. 27.10.1841. ‚úÖ Bildbewiesen. Quelle: Nr. 11 im Linder-Ordner."},
  larsmag:   {n:"Lars Magnusson",           b:"1747",         s:"M",c:"sv", fi:null,        mi:null,
             desc:"Lars M√•nsson/Magnusson, f√∂dd 25.9.1747 i √Ösbo. Far till Brita Helena Larsdotter (*6.11.1779). K√§lla: Linder-p√§rmens Nr 22 (07-nr19-22.heic).",
             desc_de:"Lars M√•nsson/Magnusson, geb. 25.9.1747 in √Ösbo. Vater von Brita Helena Larsdotter (*1779). Quelle: Ahnentafel-Dokument, Nr. 22."},
  catharinasv:{n:"Catharina Svensdotter",   b:"1762",         s:"F",c:"sv", fi:null,        mi:null,
             desc:"Catharina Svensdotter, f√∂dd 13.3.1762. Mor till Brita Helena Larsdotter (*1779). K√§lla: Linder-p√§rmens Nr 23 (08-nr22-26.heic).",
             desc_de:"Catharina Svensdotter, geb. 13.3.1762. Mutter von Brita Helena Larsdotter (*1779). Quelle: Ahnentafel-Dokument, Nr. 23."},
  alma:      {n:"Alma Maria Linder",       b:"1888",d:"1932", s:"F",c:"sv", fi:"augustl",   mi:"hildac",
             desc:"Alma Maria Linder, gift med Kalle Bank. Dog 1932 vid 43 √•rs √•lder i sjukdom ‚Äî Yngve var bara 7 √•r gammal n√§r hon gick bort. Begravd i Mj√∂lby. F√∂r√§ldrar: Carl August Linder (kvarnarbetare) och Hilda Carolina Gustafson ‚Äî bekr√§ftat i folkr√§kning 1890.",
             desc_de:"Alma Maria Linder, verheiratet mit Kalle Bank. Starb 1932 im Alter von 43 Jahren ‚Äî Yngve war erst 7 Jahre alt. In Mj√∂lby begraben. Eltern: Carl August Linder und Hilda Carolina Gustafson ‚Äî best√§tigt in der Volksz√§hlung 1890."},
  olof:      {n:"Olof Hilmer Carlsson",    b:"1883",          s:"M",c:"svb",fi:null,        mi:null},
  elsa:      {n:"Elsa Charlotta Bergman",  b:"1890",          s:"F",c:"svb",fi:"alfred",    mi:"amanda"},
  petar:     {n:"Petar Mitrovic",          b:null, d:"~1917", s:"M",c:"rs", fi:null,        mi:null,  x:"‚Ä†WWI"},
  stanija:   {n:"Stanija Blagojevic",      b:"~1886",         s:"F",c:"rs", fi:"jovanovic", mi:null,
             desc:"Stanija Blagojevic (f. Jovanovic), fr√•n Soko Banja. Hennes far √§gde kvarn och g√§sthus n√§ra staden. Fick tre s√∂ner med oklart om de hade samma far. √Ñldste sonen Milorad (Mile) bodde kvar i Zajeƒçar; mellanbroder Dimitri f√∂rsvann sp√•rl√∂st vid bulgariska gr√§nsen; yngste sonen Ceda √∂verlevde F√∂rintelsen. Stanija dog i Zajeƒçar, √•r ok√§nt.",
             desc_de:"Stanija Blagojevic (geb. Jovanovic), aus Soko Banja. Ihr Vater besa√ü eine M√ºhle und ein Gasthaus in der N√§he der Stadt. Bekam drei S√∂hne, m√∂glicherweise von verschiedenen V√§tern. √Ñltester Sohn Milorad (Mile) blieb in Zajeƒçar; Sohn Dimitri verschwand spurlos an der bulgarischen Grenze; j√ºngster Sohn Ceda √ºberlebte den Holocaust. Stanija starb in Zajeƒçar, Todesjahr unbekannt."},
  willibald: {n:"Willibald Lammerding",    b:"1895",d:"1940", s:"M",c:"de", fi:"hermann",   mi:"paula",
             desc:"Willibald Lammerding, son till skr√§ddarm√§staren Hermann. F√∂delse√•r 1895 bekr√§ftat i dopbok St. Nikomedes, Borghorst (Matricula Online, nr 142) ‚Äî d√∂pt 14.7.1895, faddrar: Willibald Vorspohl och Sophia H. Jahreing. Dog 10 juni 1940 i Borghorst.",
             desc_de:"Willibald Lammerding, Sohn des Schneidermeisters Hermann. Geburtsjahr 1895 best√§tigt im Taufbuch St. Nikomedes, Borghorst (Matricula Online, Nr. 142) ‚Äî getauft am 14.7.1895, Taufpaten: Willibald Vorspohl und Sophia H. Jahreing. Gestorben am 10. Juni 1940 in Borghorst."},
  trudis:    {n:"Gertrud Schr√§der",        b:"1896",d:"1977", s:"F",c:"de", fi:"josefb",    mi:"mkcordes"},
  toza:      {n:"Toza Blagojevic",         b:null,            s:"M",c:"rs", fi:"jovanovic", mi:null,  x:"Ni≈°"},
  dunja:     {n:"Dunja",                   b:null,            s:"F",c:"rs", fi:"jovanovic", mi:null,  x:"Belgrad"},
  mathildes: {n:"Mathilde Schr√§der",       b:"1887",          s:"F",c:"de", fi:"josefb",    mi:"mkcordes"},
  franzs:    {n:"Franz Schr√§der",          b:"1889",          s:"M",c:"de", fi:"josefb",    mi:"mkcordes"},
  marias:    {n:"Maria Schr√§der",          b:"1894",          s:"F",c:"de", fi:"josefb",    mi:"mkcordes", x:"T4?"},
  alfred:    {n:"Alfred Bergman",          b:"1863",          s:"M",c:"svb",fi:null,        mi:null,  x:"Lysekil"},
  amanda:    {n:"Amanda Str√∂mberg",        b:"1868",          s:"F",c:"svb",fi:null,        mi:null},
  jovanovic: {n:"Jovanovic (far)",         b:"~1855",         s:"M",c:"rs", fi:null,        mi:null,  x:"Soko Banja"},
  hermann:   {n:"Hermann Lammerding",      b:"1858",d:"1922", s:"M",c:"de", fi:"bernhard",  mi:"elisabethw"},
  paula:     {n:"Paula Vorspohl",          b:"1862",d:"1929", s:"F",c:"de", fi:"heinrichv", mi:"anna_s"},
  josefb:    {n:"Josef B. Schr√§der",       b:"1859",d:"1930", s:"M",c:"de", fi:"heinrichs", mi:"antonette"},
  mkcordes:  {n:"Maria K. Cordes",         b:"1857",d:"1904", s:"F",c:"de", fi:"theodor",   mi:"mkteves"},
  bernhard:  {n:"Bernhard Lammerding",     b:null,            s:"M",c:"de", fi:null,        mi:null},
  elisabethw:{n:"Elisabeth Wewermann",     b:null,            s:"F",c:"de", fi:null,        mi:null},
  heinrichv: {n:"Heinrich Vorpohl",        b:"1829",          s:"M",c:"de", fi:null,        mi:null},
  anna_s:    {n:"Anna Spenneberg",         b:"1831",          s:"F",c:"de", fi:null,        mi:null},
  heinrichs: {n:"Heinrich Schr√§der",       b:null,            s:"M",c:"de", fi:null,        mi:null},
  antonette: {n:"Antonette Laumann",       b:null,            s:"F",c:"de", fi:null,        mi:null},
  theodor:   {n:"Theodor Cordes",          b:null,            s:"M",c:"de", fi:null,        mi:null},

  // Partners gen 0
  jorg:     {n:"J√∂rg Teichgraeber",   b:"1972", s:"M", c:"mix", fi:null,      mi:null},
  alaya:    {n:"Alaya",               b:"1986", s:"F", c:"mix", fi:null,      mi:null},
  // Barnbarn (Sannas och Mattis barn)
  malva:    {n:"Malva",               b:"2021", s:"F", c:"mix", fi:"jorg",    mi:"sanna"},
  milo_t:   {n:"Milo",                b:"2025", s:"M", c:"mix", fi:"jorg",    mi:"sanna"},
  alma_c:   {n:"Alma",                b:"2021", s:"F", c:"mix", fi:"matti",   mi:"alaya"},
  vide:     {n:"Vide",                b:"2023", s:"M", c:"mix", fi:"matti",   mi:"alaya"},
  // Veras barn
  tom_h:    {n:"Tom Hartmann",        b:"1973", s:"M", c:"rs",  fi:null,      mi:"vera"},
  jana_s:   {n:"Jana",                b:"1980", s:"F", c:"rs",  fi:null,      mi:"vera"},
  // Jelas barn
  julian_s: {n:"Julian Siegler",      b:"1982", s:"M", c:"rs",  fi:null,      mi:"jela"},
  philipp_k:{n:"Philipp Kirchner",    b:"1988", s:"M", c:"rs",  fi:null,      mi:"jela"},
  // Anne-Maries barn (Huskvarna)
  hans_am:  {n:"Hans",                b:null,   s:"M", c:"sv",  fi:null,      mi:"annemarie"},
  karin_am: {n:"Karin",               b:null,   s:"F", c:"sv",  fi:null,      mi:"annemarie"},
  gunnar_am:{n:"Gunnar",              b:null,   s:"M", c:"sv",  fi:null,      mi:"annemarie"},
  // Elisabeths d√∂ttrar
  linda:    {n:"Linda Greider",       b:null,   s:"F", c:"sv",  fi:null,      mi:"elisabeth"},
  liza:     {n:"Liza Nilsson",        b:null,   s:"F", c:"sv",  fi:null,      mi:"elisabeth"},
  // Huldas barn
  rustan:   {n:"Rustan Jonsson",      b:null,   s:"M", c:"svb", fi:null,      mi:"hulda"},
  sverker:  {n:"Sverker Jonsson",     b:null,   s:"M", c:"svb", fi:null,      mi:"hulda"},
  // Tor Elofs barn
  ralf:     {n:"Ralf",                b:null,   s:"M", c:"svb", fi:"torelof", mi:null},
  torleif:  {n:"Tor-Leif",            b:null,   s:"M", c:"svb", fi:"torelof", mi:null},
  annalena: {n:"Anna-Lena",           b:null,   s:"F", c:"svb", fi:"torelof", mi:null},
  // Karins son
  magnus:   {n:"Magnus Lin√©r",        b:null,   s:"M", c:"svb", fi:null,      mi:"karin"},
  // Franz Lammerdings barn
  ruth_l:   {n:"Ruth",                b:"1964", s:"F", c:"de",  fi:"franzl",  mi:null},
  rolf_l:   {n:"Rolf",                b:"1965", s:"M", c:"de",  fi:"franzl",  mi:null},
  ute_l:    {n:"Ute",                 b:"1966", s:"F", c:"de",  fi:"franzl",  mi:null},
  elke_l:   {n:"Elke",                b:"1966", s:"F", c:"de",  fi:"franzl",  mi:null},
  stefan_l: {n:"Stefan",              b:"1967", s:"M", c:"de",  fi:"franzl",  mi:null},
  // Gertrud Lammerdings son
  udo:      {n:"Udo Schubert",        b:"1963", s:"M", c:"de",  fi:null,      mi:"gertrudl"},
  mkteves:   {n:"Maria K. Teves",          b:null,            s:"F",c:"de", fi:null,        mi:null},
};
Object.keys(P).forEach(id => P[id].id = id);

// ‚ïê‚ïê‚ïê‚ïê LAYOUT CONSTANTS ‚ïê‚ïê‚ïê‚ïê
const CARD_W  = 168;
const COL_GAP = 40;
const COL_W   = CARD_W + COL_GAP;
const LEAF_H  = 46;   // px per leaf slot
const MAX_G   = 9;    // max generations (√∂ka vid behov)

// ‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê
function getSibs(id) {
  const p = P[id];
  return Object.values(P).filter(o =>
    o.id !== id &&
    ((p.fi && o.fi === p.fi) || (p.mi && o.mi === p.mi))
  );
}

function buildSlots(rootId) {
  const slots = [[rootId]];
  for (let g = 0; g < MAX_G - 1; g++) {
    const next = [];
    let any = false;
    for (const id of slots[g]) {
      const p = id ? P[id] : null;
      const f = p ? p.fi || null : null;
      const m = p ? p.mi || null : null;
      next.push(f, m);
      if (f || m) any = true;
    }
    if (!any) break;
    slots.push(next);
  }
  return slots;
}

function dateStr(p) {
  const parts = [];
  if (p.b) parts.push('*' + p.b);
  if (p.d) parts.push('‚Ä†' + p.d);
  return parts.join('  ');
}

const COLORS = {
  sv:'#5ab6e0', svb:'#52bb52', rs:'#e06060', de:'#d0b040', mix:'#9060d0', unk:'#bbb'
};

function getChildren(id) {
  return Object.values(P).filter(o => o.fi === id || o.mi === id);
}

function getSpouses(id) {
  const children = getChildren(id);
  const seen = new Set();
  const result = [];
  children.forEach(c => {
    const other = (c.fi === id) ? c.mi : c.fi;
    if (other && P[other] && !seen.has(other)) { seen.add(other); result.push(P[other]); }
  });
  return result;
}

// ‚ïê‚ïê‚ïê‚ïê DETAIL PANEL ‚ïê‚ïê‚ïê‚ïê
const detPanel = document.getElementById('detail');

function renderDetail(id) {
  detPanel.classList.remove('collapsed');
  if (!id || !P[id]) { detPanel.innerHTML = `<div class="det-empty">${LANG[lang].detEmpty}</div>`; return; }
  const p   = P[id];
  const col = COLORS[p.c] || '#bbb';

  function linkBtn(person) {
    return `<button class="det-link" onclick="focusPerson('${person.id}')">${person.s==='F'?'‚ôÄ':'‚ôÇ'} ${person.n}${person.b?' <small style="color:#aaa">*'+person.b+'</small>':''}</button>`;
  }

  let html = '';

  // Header
  html += `<div class="det-head" style="background:${col}18; border-left:4px solid ${col}">
    <div class="det-av" style="background:${col}">${p.s==='F'?'‚ôÄ':'‚ôÇ'}</div>
    <div style="flex:1;min-width:0">
      <div class="det-name">${p.n}</div>
      <div class="det-dates">${p.b?'*'+p.b:''}${p.b&&p.d?'&ensp;':''}${p.d?'‚Ä†'+p.d:''}</div>
    </div>
    <button id="det-close" title="St√§ng">√ó</button>
  </div>`;

  html += '<div class="det-body">';

  // Description
  const t = LANG[lang];
  const descText = p['desc_' + lang] || p.desc;
  if (descText) {
    html += `<div class="det-section"><div class="det-text">${descText}</div></div>`;
  }

  // Parents
  const father = p.fi ? P[p.fi] : null;
  const mother = p.mi ? P[p.mi] : null;
  if (father || mother) {
    html += `<div class="det-section"><h4>${t.detParents}</h4><div class="det-links">`;
    if (father) html += linkBtn(father);
    if (mother) html += linkBtn(mother);
    html += '</div></div>';
  }

  // Spouses
  const spouses = getSpouses(id);
  if (spouses.length > 0) {
    html += `<div class="det-section"><h4>${t.detSpouse}</h4><div class="det-links">`;
    spouses.forEach(sp => { html += linkBtn(sp); });
    html += '</div></div>';
  }

  // Children
  const children = getChildren(id);
  if (children.length > 0) {
    html += `<div class="det-section"><h4>${t.detChildren}</h4><div class="det-links">`;
    children.forEach(c => { html += linkBtn(c); });
    html += '</div></div>';
  }

  // Siblings
  const sibs = getSibs(id);
  if (sibs.length > 0) {
    html += `<div class="det-section"><h4>${t.detSiblings}</h4><div class="det-links">`;
    sibs.forEach(s => { html += linkBtn(s); });
    html += '</div></div>';
  }

  // Short note (x field)
  if (p.x && !descText) {
    html += `<div class="det-section"><h4>${t.detNote}</h4><div class="det-note">${p.x}</div></div>`;
  }

  // Fotol√§nk till Google Photos (visas bara f√∂r godk√§nda)
  if (approved) {
    const searchUrl = 'https://photos.google.com/search/' + encodeURIComponent(id);
    html += `<div class="det-section"><a class="photos-link" href="${searchUrl}" target="_blank" rel="noopener">üì∑ Se foton i Google Photos</a></div>`;
  }

  html += '</div>'; // det-body
  detPanel.innerHTML = html;
  document.getElementById('det-close').addEventListener('click', () => {
    detPanel.classList.add('collapsed');
  });
}

// ‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê
const hist = [];
let currentRoot = 'lasse';

// ‚ïê‚ïê‚ïê‚ïê DOM REFS ‚ïê‚ïê‚ïê‚ïê
const viewport  = document.getElementById('viewport');
const wrap      = document.getElementById('wrap');
const cv        = document.getElementById('cv');
const backBtn   = document.getElementById('back');
const focusName = document.getElementById('focus-name');

// ‚ïê‚ïê‚ïê‚ïê FOCUS ‚ïê‚ïê‚ïê‚ïê
function focusPerson(id) {
  if (!P[id] || id === currentRoot) return;
  hist.push(currentRoot);
  currentRoot = id;
  const doRender = () => { render(id); renderDetail(id); };
  if (document.startViewTransition) {
    wrap.querySelectorAll('.card[data-id]').forEach(c => {
      c.style.viewTransitionName = 'pers-' + c.dataset.id;
    });
    document.startViewTransition(doRender);
  } else {
    doRender();
  }
  backBtn.disabled = false;
}

backBtn.addEventListener('click', () => {
  if (!hist.length) return;
  const prev = hist.pop();
  currentRoot = prev;
  render(prev);
  renderDetail(prev);
  backBtn.disabled = hist.length === 0;
});

// ‚ïê‚ïê‚ïê‚ïê LINE DRAWING ‚ïê‚ïê‚ïê‚ïê
// En L-formad stig per f√∂r√§lder, ritad i f√∂r√§lderns nationalitetsf√§rg.
// √ñverlappande L-shapes skapar ett T-kopplings-utseende utan neutrala gr√• linjer.
// Halvpixel-snappning (+0.5) ger skarpa linjer p√• canvas.
function drawLines(ctx, slots, pos) {
  ctx.clearRect(0, 0, cv.width, cv.height);
  ctx.lineWidth = 1.5;
  ctx.lineCap  = 'round';
  ctx.lineJoin = 'round';

  for (let g = 1; g < slots.length; g++) {
    for (let ci = 0; ci < slots[g - 1].length; ci++) {
      const childId = slots[g - 1][ci];
      if (!childId || !pos[childId]) continue;

      const ch = pos[childId];
      const cx = Math.round(ch.x + CARD_W)               + 0.5;  // barnets h√∂gerkant
      const cy = Math.round(ch.y)                         + 0.5;  // barnets mittpunkt y
      const bx = Math.round(ch.x + CARD_W + COL_GAP / 2) + 0.5;  // greningspunkt (mitt i gapet)

      // T-koppling: mor ritas f√∂rst, far ritas sist och skriver √∂ver det delade horisontella skaftet.
      // Det g√∂r att skaftet (barn‚Üígren) f√•r faderns (√∂vre) f√§rg, inte moderns.
      [slots[g][ci * 2 + 1], slots[g][ci * 2]].forEach(pId => {
        if (!pId || !pos[pId]) return;
        const px = Math.round(pos[pId].x) + 0.5;  // f√∂r√§lderns v√§nsterkant
        const py = Math.round(pos[pId].y) + 0.5;  // f√∂r√§lderns mittpunkt y

        ctx.strokeStyle = COLORS[P[pId].c] || '#aaa';
        ctx.beginPath();
        ctx.moveTo(cx, cy);   // barnets h√∂gerkant
        ctx.lineTo(bx, cy);   // v√§nsterskaft ‚Üí greningspunkt
        ctx.lineTo(bx, py);   // vertikalt till f√∂r√§lderns h√∂jd
        ctx.lineTo(px, py);   // h√∂gerskaft ‚Üí f√∂r√§lderns v√§nsterkant
        ctx.stroke();
      });
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê‚ïê
function render(rootId) {
  const slots  = buildSlots(rootId);
  const numG   = slots.length;
  // Use actual populated entries across all generations, not theoretical 2^n
  const maxPop = Math.max(...slots.map(g => g.filter(id => id !== null).length));
  const totalH = Math.max(maxPop * LEAF_H, 300);
  const totalW = numG * COL_W + 40;
  const PAD_X  = 20;
  const PAD_Y  = 60;

  // Resize canvas and wrap
  const canvasH = totalH + PAD_Y * 2;
  wrap.style.width  = totalW + 'px';
  wrap.style.height = canvasH + 'px';
  cv.width  = totalW;
  cv.height = canvasH;

  // Clear old cards (keep canvas)
  wrap.querySelectorAll('.card, .gen-lbl').forEach(el => el.remove());

  // Compute positions
  const pos = {};
  slots.forEach((gen, g) => {
    const numSlots = gen.length;
    const slotH = totalH / numSlots;
    gen.forEach((id, i) => {
      if (!id) return;
      pos[id] = {
        x: PAD_X + g * COL_W,
        y: PAD_Y + (i + 0.5) * slotH,
      };
    });
  });

  // Gen labels
  const GEN_LABELS = LANG[lang].genLabels;
  slots.forEach((gen, g) => {
    const lbl = document.createElement('div');
    lbl.className = 'gen-lbl';
    lbl.textContent = GEN_LABELS[g] || `Gen ${g}`;
    lbl.style.left = (PAD_X + g * COL_W) + 'px';
    wrap.appendChild(lbl);
  });

  // Render cards
  slots.forEach((gen, g) => {
    gen.forEach((id) => {
      if (!id) return;
      const p   = P[id];
      const pos_p = pos[id];
      const sibs = getSibs(id);
      const isFocus = (id === rootId);

      const card = document.createElement('div');
      card.className = 'card c-' + p.c + (isFocus ? ' focused' : '');
      card.dataset.id = id;
      card.style.left = pos_p.x + 'px';
      card.style.top  = pos_p.y + 'px';

      // Avatar
      const av = document.createElement('div');
      av.className = 'av';
      av.textContent = p.s === 'F' ? '‚ôÄ' : '‚ôÇ';
      card.appendChild(av);

      // Info block
      const info = document.createElement('div');
      info.className = 'info';

      const nm = document.createElement('div');
      nm.className = 'nm';
      nm.textContent = p.n;
      info.appendChild(nm);

      const dt = document.createElement('div');
      dt.className = 'dt';
      dt.textContent = dateStr(p);
      if (p.x) {
        const nt = document.createElement('span');
        nt.className = 'note';
        nt.textContent = ' ¬∑ ' + p.x;
        dt.appendChild(nt);
      }
      info.appendChild(dt);

      // Sibling chips
      if (sibs.length > 0) {
        const sibsDiv = document.createElement('div');
        sibsDiv.className = 'sibs';
        sibs.forEach(s => {
          const btn = document.createElement('button');
          btn.className = 'sib sib-' + s.c;
          const shortName = s.n.split(' ')[0];
          const yr = s.b ? s.b.replace('~','').replace('ca ','') : '';
          btn.textContent = shortName + (yr ? ' ' + yr : '') + (s.d ? ' ‚Ä†' : '');
          btn.title = s.n + (s.b ? ' *'+s.b : '') + (s.d ? ' ‚Ä†'+s.d : '');
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            focusPerson(s.id);
          });
          sibsDiv.appendChild(btn);
        });
        info.appendChild(sibsDiv);
      }

      // Children chips
      const children = getChildren(id);
      if (children.length > 0) {
        const barnDiv = document.createElement('div');
        barnDiv.className = 'barn';
        children.forEach(c => {
          const btn = document.createElement('button');
          btn.className = 'child child-' + c.c;
          const firstName = c.n.split(' ')[0];
          const yr = c.b ? ' ' + c.b.replace('~','').replace('ca ','').substring(0,4) : '';
          btn.textContent = firstName + yr + (c.d ? ' ‚Ä†' : '');
          btn.title = c.n + (c.b ? ' *'+c.b : '') + (c.d ? ' ‚Ä†'+c.d : '');
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            focusPerson(c.id);
          });
          barnDiv.appendChild(btn);
        });
        info.appendChild(barnDiv);
      }

      card.appendChild(info);

      // Click on card itself = focus, or re-open panel if already focused
      if (!isFocus) {
        card.addEventListener('click', () => focusPerson(id));
      } else {
        card.addEventListener('click', () => {
          detPanel.classList.remove('collapsed');
          renderDetail(id);
        });
      }

      // Fotoikon p√• kort (f√∂r godk√§nda)
      if (approved) {
        const dot = document.createElement('a');
        dot.className = 'photo-dot';
        dot.textContent = 'üì∑';
        dot.href = 'https://photos.google.com/search/' + encodeURIComponent(id);
        dot.target = '_blank';
        dot.rel = 'noopener';
        dot.title = 'Se foton i Google Photos';
        dot.addEventListener('click', e => e.stopPropagation());
        card.appendChild(dot);
      }

      wrap.appendChild(card);
    });
  });

  // Initial line draw
  const ctx = cv.getContext('2d');
  drawLines(ctx, slots, pos);

  // Two-pass layout: measure actual card heights, fix overlaps, re-centre parents
  requestAnimationFrame(() => {
    const GAP = 2;

    // Pass 1‚Üí0: from deepest generation inward.
    // For each generation: recalculate y as midpoint of children (except deepest),
    // then push cards down to eliminate overlaps.
    for (let g = slots.length - 1; g >= 0; g--) {
      // Reposition to midpoint of children (skip deepest level)
      if (g < slots.length - 1) {
        slots[g].forEach((id, i) => {
          if (!id) return;
          const fId = slots[g + 1][i * 2];
          const mId = slots[g + 1][i * 2 + 1];
          const fY = (fId && pos[fId]) ? pos[fId].y : null;
          const mY = (mId && pos[mId]) ? pos[mId].y : null;
          if      (fY !== null && mY !== null) pos[id].y = (fY + mY) / 2;
          else if (fY !== null)                pos[id].y = fY;
          else if (mY !== null)                pos[id].y = mY;
        });
      }
      // Fix overlaps top‚Üíbottom within this column.
      // Extra FAMILY_SEP gap between different families (varje par far+mor = en familj).
      const FAMILY_SEP_SAME  = 50;   // gap mellan familjer av samma nationalitet
      const FAMILY_SEP_DIFF  = 120;  // extra stort gap n√§r nationalitet byter
      let prevBot = -Infinity;
      let prevFamilyGroup = -1;
      let prevColor = '';
      slots[g].forEach((id, j) => {
        if (!id || !pos[id]) return;
        const card = wrap.querySelector(`.card[data-id="${id}"]`);
        if (!card) return;
        const h = card.offsetHeight;
        const familyGroup = Math.floor(j / 2);
        const curColor = P[id]?.c || '';
        const colorChanged = prevColor && curColor && prevColor !== curColor;
        const sep = colorChanged ? FAMILY_SEP_DIFF : FAMILY_SEP_SAME;
        const extraGap = (familyGroup > prevFamilyGroup && prevFamilyGroup >= 0) ? sep : 0;
        const minY = prevBot + GAP + extraGap + h / 2;
        if (pos[id].y < minY) pos[id].y = minY;
        card.style.top = pos[id].y + 'px';
        prevBot = pos[id].y + h / 2;
        prevFamilyGroup = familyGroup;
        prevColor = curColor;
      });
    }

    // Expand canvas/wrap if cards were pushed below the original bounds
    let maxBot = 0;
    wrap.querySelectorAll('.card').forEach(c => {
      const b = parseFloat(c.style.top) + c.offsetHeight / 2;
      if (b > maxBot) maxBot = b;
    });
    const needed = maxBot + PAD_Y;
    if (needed > cv.height) {
      cv.height = needed;
      wrap.style.height = needed + 'px';
    }

    // Redraw lines with corrected positions
    drawLines(ctx, slots, pos);

    // Auto-fit on first load: zoom out so all generations are visible
    if (hist.length === 0) {
      const vp = document.getElementById('viewport');
      const contentW = parseFloat(wrap.style.width)  || cv.width;
      const contentH = parseFloat(wrap.style.height) || cv.height;
      const fitZoom = Math.min(
        (vp.clientWidth  - 20) / contentW,
        (vp.clientHeight - 20) / contentH,
        1.0   // never zoom in on first load, only out
      );
      zoom = Math.max(0.3, fitZoom);
    }
    applyZoom();
  });

  // Update header
  focusName.textContent = P[rootId] ? P[rootId].n : '';
}

// ‚ïê‚ïê‚ïê‚ïê ZOOM ‚ïê‚ïê‚ïê‚ïê
let zoom = 1;
const zoomLayer = document.getElementById('zoom-layer');

function applyZoom() {
  wrap.style.transform = `scale(${zoom})`;
  wrap.style.transformOrigin = 'top left';
  const w = parseFloat(wrap.style.width)  || 0;
  const h = parseFloat(wrap.style.height) || 0;
  zoomLayer.style.width  = (w * zoom) + 'px';
  zoomLayer.style.height = (h * zoom) + 'px';
}

document.getElementById('zoom-in').addEventListener('click', () => {
  zoom = Math.min(2.2, zoom + 0.15); applyZoom();
});
document.getElementById('zoom-out').addEventListener('click', () => {
  zoom = Math.max(0.3, zoom - 0.15); applyZoom();
});

// Pinch-to-zoom
let pinchDist0 = null, zoom0 = 1;
viewport.addEventListener('touchstart', e => {
  if (e.touches.length === 2) {
    pinchDist0 = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    zoom0 = zoom;
  }
}, { passive: true });
viewport.addEventListener('touchmove', e => {
  if (e.touches.length === 2 && pinchDist0) {
    const d = Math.hypot(
      e.touches[0].clientX - e.touches[1].clientX,
      e.touches[0].clientY - e.touches[1].clientY
    );
    zoom = Math.max(0.3, Math.min(2.2, zoom0 * (d / pinchDist0)));
    applyZoom();
    e.preventDefault();
  }
}, { passive: false });
viewport.addEventListener('touchend', () => { pinchDist0 = null; });

// ‚ïê‚ïê‚ïê‚ïê LANGUAGE ‚ïê‚ïê‚ïê‚ïê
function setLang(l) {
  lang = l;
  document.body.className = 'lang-' + l;
  document.querySelectorAll('.lang-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.lang === l)
  );
  document.querySelector('#topbar h1').textContent = LANG[l].title;
  document.getElementById('back').textContent = LANG[l].back;
  document.querySelector('.hint').textContent = LANG[l].hint;
  document.getElementById('auth-open-btn').textContent = 'üì∑ ' + LANG[l].bildarkiv;

  // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
  const L = LANG[l];
  const $ = id => document.getElementById(id);
  document.querySelector('#apply-view-request h2').textContent      = L.modalTitle;
  document.querySelector('#apply-view-request > p').textContent     = L.modalIntro;
  const lbls = document.querySelectorAll('#apply-view-request .apply-field label');
  if (lbls[0]) lbls[0].textContent = L.labelName;
  if (lbls[1]) lbls[1].textContent = L.labelEmail;
  if (lbls[2]) lbls[2].textContent = L.labelRelation;
  $('apply-name').placeholder     = L.phName;
  $('apply-relation').placeholder = L.phRelation;
  $('apply-submit').textContent   = L.btnApply;
  $('apply-cancel').textContent   = L.btnCancel;
  $('apply-cancel2').textContent  = L.btnCancel;
  $('apply-cancel3').textContent  = L.btnClose;
  document.querySelector('#apply-view-signin h2').textContent = L.signinTitle;
  document.querySelector('#apply-view-signin > p').textContent = L.signinText;
  document.querySelector('#apply-view-pending h2').textContent = L.pendingTitle;
  document.querySelector('#apply-view-pending p').innerHTML =
    L.pendingText + '<br><br><small id="apply-pending-note" style="color:#bbb"></small>';

  render(currentRoot);
  renderDetail(currentRoot);
}
document.querySelectorAll('.lang-btn').forEach(btn =>
  btn.addEventListener('click', () => setLang(btn.dataset.lang))
);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BILDARKIV ‚Äî KONFIGURATION
// Fyll i dessa tre v√§rden efter Google Cloud-setup.
// Se docs/google-setup.md f√∂r steg-f√∂r-steg-instruktioner.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GOOG_CLIENT_ID  = '954461686218-bh0238cc4ddd2eld8ju6dqb5350qaomp.apps.googleusercontent.com';
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwgRXCv0_UmjFfLb8mVb4fH_Ei_ikcD5sWXUIza82SiZM8oTZkBNnXeTCiradJkdozcHQ/exec';
const PHOTOS_ALBUM_URL = 'https://photos.app.goo.gl/taPU3v54CCnBHVX97';

// ‚ïê‚ïê‚ïê‚ïê AUTH STATE ‚ïê‚ïê‚ïê‚ïê
let authUser = null;  // { email, name, picture }
let approved  = false;
let gsiReady  = false;

// ‚ïê‚ïê‚ïê‚ïê JWT-PARSER (clientside, ingen server beh√∂vs) ‚ïê‚ïê‚ïê‚ïê
function parseJwt(token) {
  try {
    const b64 = token.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');
    return JSON.parse(atob(b64));
  } catch(e) { return null; }
}

// ‚ïê‚ïê‚ïê‚ïê GOOGLE SIGN-IN CALLBACK ‚ïê‚ïê‚ïê‚ïê
// Kallas av GIS n√§r anv√§ndaren loggat in med Google.
window.handleCredentialResponse = async function(response) {
  const jwt = parseJwt(response.credential);
  if (!jwt) return;

  authUser = {
    email:   jwt.email,
    name:    jwt.given_name || jwt.name.split(' ')[0],
    picture: jwt.picture || ''
  };

  // Uppdatera UI: visa user-chip
  document.getElementById('user-name').textContent = authUser.name;
  if (authUser.picture) document.getElementById('user-pic').src = authUser.picture;
  document.getElementById('user-chip').style.display = 'flex';
  document.getElementById('auth-open-btn').style.display = 'none';

  // Kontrollera godk√§nnandestatus mot Apps Script
  try {
    const r = await fetch(
      `${APPS_SCRIPT_URL}?action=check&token=${encodeURIComponent(response.credential)}`
    );
    const d = await r.json();
    approved = d.approved === true;
  } catch(e) { approved = false; }

  if (approved) {
    closeApplyModal();
    renderPhotoIndicators();
    renderDetail(currentRoot);
  } else {
    // Godk√§nd ans√∂kan finns men inte beviljad √§n ‚Äî visa v√§ntande vy
    const note = document.getElementById('apply-pending-note');
    if (note) note.textContent = 'Din ans√∂kan finns hos oss ‚Äî vi kommer h√∂ra av oss!';
    showApplyView('pending');
  }
};

// ‚ïê‚ïê‚ïê‚ïê UTLOGGNING ‚ïê‚ïê‚ïê‚ïê
function signOut() {
  if (typeof google !== 'undefined') google.accounts.id.disableAutoSelect();
  authUser = null;
  approved  = false;
  document.getElementById('user-chip').style.display = 'none';
  document.getElementById('auth-open-btn').style.display = '';
  document.querySelectorAll('.photo-dot').forEach(d => d.remove());
  renderDetail(currentRoot);
}

// ‚ïê‚ïê‚ïê‚ïê VISA FOTOIKONER P√Ö KORTEN ‚ïê‚ïê‚ïê‚ïê
function renderPhotoIndicators() {
  document.querySelectorAll('.card[data-id]').forEach(card => {
    if (card.querySelector('.photo-dot')) return;
    const id = card.dataset.id;
    const dot = document.createElement('a');
    dot.className = 'photo-dot';
    dot.textContent = 'üì∑';
    dot.href = 'https://photos.google.com/search/' + encodeURIComponent(id);
    dot.target = '_blank';
    dot.rel = 'noopener';
    dot.title = 'Se foton i Google Photos';
    dot.addEventListener('click', e => e.stopPropagation());
    card.appendChild(dot);
  });
}

// ‚ïê‚ïê‚ïê‚ïê ANS√ñKNINGSMODAL ‚ïê‚ïê‚ïê‚ïê
function openApplyModal() {
  document.getElementById('apply-modal').style.display = 'flex';
  if (authUser && !approved) {
    showApplyView('pending');
  } else if (authUser && approved) {
    closeApplyModal(); // redan inloggad och godk√§nd ‚Äî ska ej h√§nda
  } else {
    showApplyView('request');
  }
}

function closeApplyModal() {
  document.getElementById('apply-modal').style.display = 'none';
}

function showApplyView(v) {
  ['request','signin','pending'].forEach(n => {
    document.getElementById('apply-view-' + n).style.display = (n === v ? '' : 'none');
  });
  if (v === 'signin') ensureGSI();
}

// Initierar GIS och renderar Google-knappen (k√∂rs en g√•ng)
function ensureGSI() {
  if (gsiReady || typeof google === 'undefined') return;
  google.accounts.id.initialize({
    client_id: GOOG_CLIENT_ID,
    callback:  handleCredentialResponse,
    auto_select: false,
    use_fedcm_for_prompt: false
  });
  google.accounts.id.renderButton(
    document.getElementById('gsi-btn-container'),
    { theme: 'outline', size: 'large', width: 260, text: 'signin_with' }
  );
  gsiReady = true;
}

// ‚ïê‚ïê‚ïê‚ïê SKICKA ANS√ñKAN ‚ïê‚ïê‚ïê‚ïê
async function submitApplication() {
  const name     = document.getElementById('apply-name').value.trim();
  const email    = document.getElementById('apply-email').value.trim();
  const relation = document.getElementById('apply-relation').value.trim();
  const status   = document.getElementById('apply-status');

  if (!name || !email || !relation) {
    status.textContent = 'Fyll i alla f√§lt.';
    status.style.color = '#e06060';
    return;
  }
  if (!/\S+@\S+\.\S+/.test(email)) {
    status.textContent = 'Ange en giltig e-postadress.';
    status.style.color = '#e06060';
    return;
  }

  const btn = document.getElementById('apply-submit');
  btn.disabled = true;
  status.textContent = 'Skickar‚Ä¶';
  status.style.color = '#888';

  try {
    const params = new URLSearchParams({ action: 'apply', name, email, relation, lang });
    // no-cors: vi kan inte l√§sa svaret men Apps Script tar emot anropet
    await fetch(`${APPS_SCRIPT_URL}?${params}`, { mode: 'no-cors' });
    showApplyView('pending');
  } catch(e) {
    status.textContent = 'N√•got gick fel. F√∂rs√∂k igen eller kontakta Lasse direkt.';
    status.style.color = '#e06060';
    btn.disabled = false;
  }
}



// St√§ng modal vid klick utanf√∂r rutan
document.getElementById('apply-modal').addEventListener('click', function(e) {
  if (e.target === this) closeApplyModal();
});

// ‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê
render(currentRoot);
renderDetail(currentRoot);

// √ñppna inloggningsvyn automatiskt om URL inneh√•ller ?signin=1
// (v√§lkomstmailet l√§nkar hit med denna parameter)
if (new URLSearchParams(location.search).get('signin') === '1') {
  // V√§nta tills GIS-biblioteket √§r laddat (async defer)
  const waitForGSI = () => {
    if (typeof google !== 'undefined') {
      openApplyModal();
      showApplyView('signin');
    } else {
      setTimeout(waitForGSI, 200);
    }
  };
  waitForGSI();
}
</script>
</body>
</html>
